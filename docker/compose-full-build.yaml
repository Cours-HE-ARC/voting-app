services:

  voting-app-admin:
    build:
      context: ../voting-app-admin
      dockerfile: ../voting-app-admin/build.Dockerfile
    image: voting-app-admin
    environment:
      - SERVER_PORT=8080
    ports:
      - 11111:8080 #expose eureka registry port to host
    networks:
      - voting-app

  api-gateway:
    build:
      context: ../api-gateway
      dockerfile: ../api-gateway/build.Dockerfile
    image: api-gateway
    environment:
      - SERVER_PORT=8080
      - ADMIN_SERVER_URI=http://voting-app-admin:8080
      - EUREKA_URI=http://service-registry:8761/eureka
    ports:
      - 11110:8080 #expose eureka registry port to host

    networks:
      - voting-app

  service-registry:
    build:
      context: ../service-registry
      dockerfile: ../service-registry/build.Dockerfile
    image: service-registry
    environment:
      - SERVER_PORT=8761
      - ADMIN_SERVER_URI=http://voting-app-admin:8080
    expose:
      - 8761 #expose eureka registry port to host
    networks:
      - voting-app

  admin-service:
    build:
      context: ../admin-service
      dockerfile: ../admin-service/build.Dockerfile
    image: admin-service
    environment:
      - ACTIVEMQ_URI=tcp://active-mq:61616
      - SERVER_PORT=8080
      - MYSQL_DB=jdbc:mysql://admin-service-db:3306/admin-service?createDatabaseIfNotExist=true
      - EUREKA_URI=http://service-registry:8761/eureka
      - SPRING_PROFILES_ACTIVE=mysql
      - ADMIN_SERVER_URI=http://voting-app-admin:8080

    expose:
      - 8080
    deploy:
      mode: replicated
      replicas: 2
      endpoint_mode: vip
    networks:
      - voting-app
    depends_on:
      - active-mq
      - admin-service-db
      - service-registry

  voting-service:
    build:
      context: ../voting-service
      dockerfile: ../voting-service/build.Dockerfile
    image: voting-service
    environment:
      - ACTIVEMQ_URI=tcp://active-mq:61616
      - SERVER_PORT=8080
      - MYSQL_DB=jdbc:mysql://voting-service-db:3306/voting-service?createDatabaseIfNotExist=true
      - EUREKA_URI=http://service-registry:8761/eureka
      - SPRING_PROFILES_ACTIVE=mysql
      - ADMIN_SERVER_URI=http://voting-app-admin:8080

    expose:
      - 8080
    deploy:
      mode: replicated
      replicas: 2
      endpoint_mode: vip
    networks:
      - voting-app
    depends_on:
      - active-mq
      - voting-service-db
      - service-registry

  active-mq:
    image: apache/activemq-artemis:latest-alpine
    expose:
      - 61616
      - 8161
    environment:
      - ARTEMIS_USER=mq
      - ARTEMIS_PASSWORD=mq
    networks:
      - voting-app

  admin-service-db:
    image: mysql:8.2.0-oracle
    expose:
      - 3306
    volumes:
      - "mysql_admin:/var/lib/mysql"
    environment:
      - MYSQL_ROOT_PASSWORD=root
    restart: always
    networks:
      - voting-app

  voting-service-db:
    image: mysql:8.2.0-oracle
    expose:
      - 3306
    volumes:
      - "mysql_voting:/var/lib/mysql"
    environment:
      - MYSQL_ROOT_PASSWORD=root
    restart: always
    networks:
      - voting-app

volumes:
  mysql_admin:
  mysql_voting:

networks:
  voting-app:
    driver: bridge
